using System;
using System.Collections.Generic;
using System.Windows.Forms;
using System.Runtime.InteropServices;
using System.Threading;
using NDesk.Options;
using System.Data.SqlClient;
using System.IO;







 
namespace GadgetLoader
{
    static class Program
    {
        // from
        // http://stackoverflow.com/questions/7198639/c-application-both-gui-and-commandline

        [DllImport("kernel32.dll")]
        static extern bool AttachConsole(int dwProcessId);
        private const int ATTACH_PARENT_PROCESS = -1;

        /// <summary>
        /// The main entry point for the application.
        /// </summary>

        [STAThread]
        static void Main(string[] args)
        {
            AttachConsole(ATTACH_PARENT_PROCESS);

            CommandLineOptions opts = new CommandLineOptions();
            
            
            var par = new OptionSet()
            {
                //need to throw option exceptions for all options that have non-optionable values
                { "g|gui", "launches the gui, all other options are ignored",
                    v => {if (v != null) opts.gui = true; } },

                { "z|timestep=", "sets the {TIMESTEP} to transform",
                    (short v) => {opts.timestep = v; } },
                { "d|database=", "dictates what database the data will be loaded into",
                    v => {opts.database = v; } },
                { "r|server=", "dictates what server the database is on",
                    v => {opts.server = v; } },
                { "t|fft", "loads the fft data",
                    v => {opts.fft = true; } },
                { "f|fof", "loads the fof data",
                    v => {opts.fof = true; } },
                { "s|snap", "loads the particle data",
                    v => {opts.snap = true; } },
                { "p|phbits=", "sets the {NUMBER} of bits to use when calculating Peano-Hilbert index",
                    (int v) => {opts._phbits = v; } },
                { "n|nzones=", "sets the {NUMBER} of zones",
                    (int v) => { opts._nzones = v; } },
                { "b|box=", "sets the {SIZE} of the simulation box",
                    (int v) => { opts._boxsize = v; } },
                { "q|sqlcf=", "sets the {NAME} of the SQL command file to write to",
                    v => { if (v == null)
                                    throw new OptionException ("Missing the name of the SQL commands file for option -sqlcf", "-sqlcf");
                                 opts.sqlCF = v; } },
                { "h|help", "Show this message and exit",
                    v => opts.show_help = v != null },
            };
            
            
            if (args.Length > 0)
            {
                try
                {
                    par.Parse(args);
                }
                    //TODO SUMMARY
                catch (OptionException e)
                {
                    Console.Write("GadgetLoader: ");
                    Console.WriteLine(e.Message);
                    Console.WriteLine("Try 'GadgetLoader --help' for more information.");
                    return;
                }

                if (!opts.validOptions())
                {
                    ShowHelp(par);
                    return;
                }

                if (opts.show_help)
                {
                    ShowHelp(par);
                    return;
                }

                if (opts.gui)
                {
                    Application.EnableVisualStyles();
                    Application.SetCompatibleTextRenderingDefault(false);
                    Application.Run(new frmMain());
                }
                else
                {
                    Runner runner = new Runner(opts.sqlCF);

                    GlobalParameters globalParameters = RefreshGlobalParameters(opts);

                    try
                    {
                        RefreshProcess(globalParameters, runner, opts);
                        runner.Run();
                    }
                    catch (Exception e)
                    {
                        globalParameters.summary.addError(e.Message);
                    }
                    finally
                    {
                        globalParameters.summary.writeSummary();
                        globalParameters.summary.writeBCPFile();
                        System.Windows.Forms.SendKeys.SendWait("{ENTER}");
                    }
                }

            }
                //If no options, run gui
            else
            {
                Application.EnableVisualStyles();
                Application.SetCompatibleTextRenderingDefault(false);
                Application.Run(new frmMain());
            }
        }


        public static void ShowHelp(OptionSet p)
        {
            Console.WriteLine("Usage: GadgetLoader [OPTIONS]");
            Console.WriteLine("If no arguments specified, the GUI is launched\n");
            Console.WriteLine("Options:");
            p.WriteOptionDescriptions(Console.Out);
            System.Windows.Forms.SendKeys.SendWait("{ENTER}");
        }

        #region Process Initialization




        /// <summary>
        /// Create new Process and fill with parameters from config files
        /// </summary>

        private static void RefreshProcess(GlobalParameters gp, Runner runner, CommandLineOptions opts)
        {
            string inpath = "";
            string outpath = "";

            try
            {

                SqlConnection conn = new SqlConnection(LoaderConstants.configTableConnectionString);
                conn.Open();

                SqlDataReader myReader = null;
                string command = "select * from dbo.config where snapnum = @snapnum";
                SqlCommand myCommand = new SqlCommand(command, conn);
                SqlParameter timestepParam = new SqlParameter("@snapnum", System.Data.SqlDbType.SmallInt);
                timestepParam.Value = opts.timestep;
                myCommand.Parameters.Add(timestepParam);
                myReader = myCommand.ExecuteReader();

                //Can add any other properties we want to read from DB here
                int numLines = 0;
                while (myReader.Read())
                {
                    inpath = myReader[1].ToString();
                    outpath = myReader[2].ToString();
                    numLines++;
                }

                conn.Close();


                if (numLines > 1)
                {
                    throw new ConfigurationException(
                        "Multiple entries matching this snapshot in configuration table");
                }
                else if (numLines < 1)
                {
                    throw new ConfigurationException(
                        "Zero entries matching this snapshot in configuration table");
                }



                gp.summary.setFile(outpath + "\\summary");




            }
            /*catch (Exception e)
            {
                Console.Out.WriteLine("Caugth DB exception");
                gp.summary.addError(e.Message);
                return;
            }*/

            catch (Exception e)
            {
                throw;
            }

            if (opts.snap)
            {
                Console.WriteLine("Adding Snapshot process to runner");
                runner.Add(RefreshSnapshotsProcess(gp, inpath, outpath, opts));
            }
            if (opts.fof)
            {
                runner.Add(RefreshIndraFOFProcess(gp, inpath, outpath, opts));
            }
            if (opts.fft)
            {
                runner.Add(RefreshIndraFFTProcess(gp, inpath, outpath, opts));
            }

        }

        private static SnapshotsProcess RefreshSnapshotsProcess(GlobalParameters gp, string inpath, string outpath, CommandLineOptions opts)
        {
            SnapshotsProcess process = new SnapshotsProcess(gp);

            process.inPath = inpath;
            process.outPath = outpath;

            process.snapshotFilePrefix = LoaderConstants.snapFilePrefix;
            
            /* If we don't set the first and last snapshot files manually, the loader
             * will read how many subfiles the snapshot is supposed to have and read
             * that many*/
            
            
            //process.firstSnapshotFile = LoaderConstants.snapStartFile;
            //process.lastSnapshotFile = LoaderConstants.snapEndFile;
            process.snapNumber = opts.timestep;

            //TODO: HARDCODED
            process.writeArrays = true;

            return process;
        }

        private static IndraFOFProcess RefreshIndraFOFProcess(GlobalParameters gp, string inpath, string outpath, CommandLineOptions opts)
        {
            IndraFOFProcess process = new IndraFOFProcess(gp);
            process.inPath = inpath;
            process.outPath = outpath;
            process.groupTabFilePrefix = LoaderConstants.groupTabPrefix;
            process.groupIDFilePrefix = LoaderConstants.groupIDPrefix;
            //process.firstSnapshotFile = LoaderConstants.fofFirstSnapshot;
            //process.lastSnapshotFile = LoaderConstants.fofLastSnapshot;
            process.snapnumber = opts.timestep;
            return process;
        }

        private static IndraFFTDataProcess RefreshIndraFFTProcess(GlobalParameters gp, string inpath, string outpath, CommandLineOptions opts)
        {
            IndraFFTDataProcess process = new IndraFFTDataProcess(gp);
            process.inPath = inpath;
            process.outPath = outpath;
            process.filePrefix = LoaderConstants.fftFilePrefix;
            process.fileExtension = LoaderConstants.fftFileExtension;
            process.snapnumber = opts.timestep;
            return process;
        }


        private static GlobalParameters RefreshGlobalParameters(CommandLineOptions opts)
        {
            //TODO: read param values in from param table
            return new GlobalParameters(LoaderConstants.phbits, 1, LoaderConstants.boxSize, 1, opts.sqlCF, opts.server, opts.database);
        }


        #endregion

        //TODO: Can eventually change this to write to error log
        //SUMMARY TODO
        public static void RecordError(Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    public class CommandLineOptions
    {
        public bool gui { get; set; }
        public bool fof { get; set; }
        public bool fft { get; set; }
        public bool snap { get; set; }
        public int _phbits { get; set; }
        public int _nzones { get; set; }
        public int _boxsize { get; set; }
        public int _maxRand { get; set; }
        public string sqlCF { get; set; }
        public bool show_help { get; set; }
        public short timestep {get; set; }
        public string database { get; set; }
        public string server { get; set; }

        public CommandLineOptions()
        {
            gui = false;
            fof = false;
            fft = false;
            snap = false;
            _phbits = -1;
            _nzones = 0;
            _boxsize = -1;
            _maxRand = -1;
            sqlCF = null;
        }

        public bool validOptions()
        {
            if (gui)
                return true;
            if (show_help)
                return true;
            else
            {
                /*if (_phbits < 0)
                    return false;
                if (_nzones < 0)
                    return false;
                if (_boxsize < 0)
                    return false;*/
                if (sqlCF == null)
                    return false;
                else if (server == null || database == null)
                    return false;
                return true;
            }

        }
    }

    //TODO rewrite to make all of these read in from a parameters table?
    internal static class LoaderConstants
    {

        internal const long particlesPerSnap = 134217728; //512^3

        //hardocde these for now, they can be more intelligently determined later
        internal const int bloomfilterSize = 19171;
        internal const int numberHashFunctions = 27;
        internal const int expectedSize = 500;

        //GLOBAL
        internal const int phbits = 6;
        internal const int boxSize = 1000;
        //internal const string configTableConnectionString = "server=localhost;database=SimDBdev;Trusted_Connection=true;Asynchronous Processing = true";
        
        internal const string database = "SimulationDB";
        internal const string server = "gw18";
        internal const string snapTable = "dbo.LoaderTests";
        internal const string FFTTable = "dbo.fft";
        internal const string FOFTable = "dbo.fof";
        internal const string configTableConnectionString = "server=" + server + ";database=" + database + ";Trusted_Connection=true;Asynchronous Processing = true";

        
        //SNAPSHOT particle data
        internal const int snapStartFile = 0;
        internal const int snapEndFile = 2;
        internal const string snapFilePrefix = "snapshot_";
        internal const Boolean writeArrays = true;

        //FOF
        internal const string groupTabPrefix = "grouptab_";
        internal const string groupIDPrefix = "groupid_";
        //internal const int fofStartFile = 0;
        //internal const int fofEndFile = 31;
        internal const int fofFirstSnapshot = 0;
        internal const int fofLastSnapshot = 63;

        //FFT
        internal const string fftFilePrefix = "";
        internal const string fftInPath = "";
        internal const string fftOutPath = "";
        internal const string fftFileExtension = ".dat";
        //internal const int fftFirstSnapshot = 0;
        //internal const int fftLastSnapshot = 188;

    }
}